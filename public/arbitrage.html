<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒè¾¹å¥—åˆ©æœºå™¨äºº - Polymarket</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 1600px; margin: 0 auto; }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .header h1 { font-size: 24px; display: flex; align-items: center; gap: 10px; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        
        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .status-running { background: #10b981; }
        .status-stopped { background: #6b7280; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 1200px) { .grid-3 { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 768px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }
        
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .card-title {
            font-size: 14px;
            color: #9ca3af;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-value { font-size: 28px; font-weight: 700; }
        .card-sub { font-size: 12px; color: #6b7280; margin-top: 5px; }
        
        .profit { color: #10b981; }
        .loss { color: #ef4444; }
        .warning { color: #f59e0b; }
        
        .stats-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .stats-row:last-child { border-bottom: none; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 13px; color: #9ca3af; margin-bottom: 6px; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 14px;
        }
        .form-group input:focus { outline: none; border-color: #8b5cf6; }
        .form-group small { color: #6b7280; font-size: 11px; display: block; margin-top: 4px; }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary { background: #8b5cf6; color: white; }
        .btn-primary:hover { background: #7c3aed; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; }
        .btn-secondary:hover { background: rgba(255,255,255,0.2); }
        .btn-info { background: #3b82f6; color: white; }
        .btn-info:hover { background: #2563eb; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        
        .control-panel { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
        
        /* è‡ªåŠ¨æ‰«æå¼€å…³æ ·å¼ */
        .auto-scan-toggle {
            display: flex;
            align-items: center;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #374151;
            transition: 0.3s;
            border-radius: 28px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        .toggle-switch input:checked + .toggle-slider {
            background-color: #10b981;
        }
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        .opportunity-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(16, 185, 129, 0.2));
            border: 2px solid #8b5cf6;
            padding: 20px;
            border-radius: 12px;
        }
        .opportunity-card h4 { color: #a78bfa; margin-bottom: 10px; font-size: 14px; }
        .opportunity-card.long { border-color: #10b981; }
        .opportunity-card.short { border-color: #ef4444; }
        
        .price-pair { display: flex; gap: 15px; margin: 15px 0; }
        .price-box { flex: 1; padding: 12px; border-radius: 8px; text-align: center; }
        .price-box.up { background: rgba(16, 185, 129, 0.2); }
        .price-box.down { background: rgba(239, 68, 68, 0.2); }
        .price-box .label { font-size: 11px; color: #9ca3af; }
        .price-box .value { font-size: 20px; font-weight: 700; margin: 5px 0; }
        
        .logs-container {
            background: #0d1117;
            border-radius: 12px;
            padding: 15px;
            height: 250px;
            overflow-y: auto;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
        }
        
        .log-entry { padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.03); color: #8b949e; }
        .log-entry.opportunity { color: #a78bfa; }
        .log-entry.success { color: #10b981; }
        .log-entry.error { color: #ef4444; }
        .log-entry.warning { color: #f59e0b; }
        .log-entry.info { color: #3b82f6; }
        
        .market-table { width: 100%; border-collapse: collapse; }
        .market-table th, .market-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 13px;
        }
        .market-table th { color: #9ca3af; font-weight: 500; font-size: 11px; text-transform: uppercase; }
        .market-table tbody tr:hover { background: rgba(255,255,255,0.03); }
        
        .spread-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .spread-good { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .spread-ok { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .spread-low { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }
        
        .type-badge { padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; }
        .type-long { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .type-short { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        
        .file-logs {
            background: #0d1117;
            border-radius: 12px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 11px;
        }
        
        .file-log-entry { padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.03); color: #8b949e; word-break: break-all; }
        .file-log-entry.long { color: #10b981; }
        .file-log-entry.short { color: #ef4444; }
        .file-log-entry.stats { color: #3b82f6; }
        
        .tabs { display: flex; gap: 5px; background: rgba(255,255,255,0.05); padding: 5px; border-radius: 10px; margin-bottom: 15px; }
        .tab { padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; transition: all 0.2s; color: #9ca3af; }
        .tab:hover { background: rgba(255,255,255,0.1); }
        .tab.active { background: #8b5cf6; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            background: #10b981;
            color: white;
            font-weight: 500;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.error { background: #ef4444; }
        
        .scan-progress {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .progress-bar {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #10b981);
            border-radius: 3px;
            transition: width 0.3s;
        }
        
        .empty-state { text-align: center; padding: 40px 20px; color: #6b7280; }
        .empty-state .icon { font-size: 48px; margin-bottom: 15px; }
        
        /* å¸‚åœºåˆ—è¡¨å¡ç‰‡æ ·å¼ */
        .market-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .market-item:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.3);
            transform: translateX(3px);
        }
        .market-item.type-long { border-left: 3px solid #10b981; }
        .market-item.type-short { border-left: 3px solid #ef4444; }
        
        .market-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        .market-item-title {
            font-size: 13px;
            font-weight: 500;
            color: #e5e7eb;
            flex: 1;
            margin-right: 10px;
            line-height: 1.4;
        }
        .market-item-type {
            flex-shrink: 0;
        }
        
        .market-item-prices {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .market-price {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
        }
        .market-price.yes { background: rgba(16, 185, 129, 0.15); }
        .market-price.no { background: rgba(239, 68, 68, 0.15); }
        .market-price .price-label { color: #9ca3af; font-size: 10px; }
        .market-price .price-value { font-weight: 600; font-size: 14px; margin-top: 2px; }
        .market-price.yes .price-value { color: #10b981; }
        .market-price.no .price-value { color: #ef4444; }
        
        .market-item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: #6b7280;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        .market-item-footer .spread {
            font-weight: 600;
        }
        .market-item-footer .spread.good { color: #10b981; }
        .market-item-footer .spread.ok { color: #fbbf24; }
        .market-item-footer .link-hint {
            display: flex;
            align-items: center;
            gap: 4px;
            color: #8b5cf6;
        }
        
        /* é¢„ä¸‹å•æ”¶ç›Šè®¡ç®—æ ·å¼ */
        .profit-simulation {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
        }
        .profit-simulation-title {
            font-size: 11px;
            color: #a78bfa;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .profit-simulation-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .profit-item {
            text-align: center;
            padding: 6px;
            background: rgba(255,255,255,0.03);
            border-radius: 6px;
        }
        .profit-item .label {
            font-size: 10px;
            color: #6b7280;
            margin-bottom: 3px;
        }
        .profit-item .value {
            font-size: 13px;
            font-weight: 600;
        }
        .profit-item .value.positive { color: #10b981; }
        .profit-item .value.negative { color: #ef4444; }
        .profit-item .value.neutral { color: #9ca3af; }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>âš¡ åŒè¾¹å¥—åˆ©æœºå™¨äºº</h1>
            <div class="header-right">
                <a href="/" class="btn btn-secondary btn-sm">ğŸ  ä¸»æ§å°</a>
                <div id="statusBadge" class="status-badge status-stopped">âšª å·²åœæ­¢</div>
            </div>
        </div>
        
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="grid">
            <div class="card">
                <div class="card-title">ğŸ“Š æ‰«æå¸‚åœº</div>
                <div class="card-value" id="totalMarkets">0</div>
                <div class="card-sub">æ´»è·ƒå¸‚åœºæ€»æ•°</div>
            </div>
            
            <div class="card">
                <div class="card-title">ğŸ” æ‰«ææ¬¡æ•°</div>
                <div class="card-value" id="totalScans">0</div>
                <div class="card-sub">ç´¯è®¡æ‰«æ</div>
            </div>
            
            <div class="card">
                <div class="card-title">âš ï¸ ä»·æ ¼åç¦»</div>
                <div class="card-value warning" id="deviatedMarkets">0</div>
                <div class="card-sub">ä»·æ ¼å’Œ â‰  1</div>
            </div>
            
            <div class="card">
                <div class="card-title">ğŸ¯ å¥—åˆ©æœºä¼š</div>
                <div class="card-value profit" id="opportunitiesFound">0</div>
                <div class="card-sub">ç¬¦åˆé˜ˆå€¼æ¡ä»¶</div>
            </div>
            
            <div class="card">
                <div class="card-title">ğŸ’° é¢„æœŸåˆ©æ¶¦</div>
                <div class="card-value profit" id="totalProfit">$0.00</div>
                <div class="card-sub">åŸºäºå·²æ‰§è¡Œäº¤æ˜“</div>
            </div>
            
            <div class="card">
                <div class="card-title">ğŸ“ˆ æ‰§è¡Œäº¤æ˜“</div>
                <div class="card-value" id="tradesExecuted">0</div>
                <div class="card-sub">æˆåŠŸæ‰§è¡Œ</div>
            </div>
        </div>
        
        <!-- ä¸»è¦å†…å®¹åŒº -->
        <div class="grid-3">
            <!-- å·¦ä¾§ï¼šè®¾ç½® + æ§åˆ¶ -->
            <div>
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-title">âš™ï¸ ç­–ç•¥è®¾ç½®</div>
                    <div class="form-group">
                        <label>æœ€å°ä»·å·®é˜ˆå€¼ (%)</label>
                        <input type="number" id="minSpread" value="0.5" step="0.1" min="0.1">
                        <small>ä»·æ ¼å’Œåç¦» 1 çš„æœ€å°ç™¾åˆ†æ¯”</small>
                    </div>
                    <div class="form-group">
                        <label>æ¯è¾¹äº¤æ˜“é‡‘é¢ (USDC)</label>
                        <input type="number" id="tradeAmount" value="10" step="1" min="5">
                    </div>
                    <div class="form-group">
                        <label>æ‰«æé—´éš” (ç§’)</label>
                        <input type="number" id="scanInterval" value="60" step="10" min="30">
                        <small>å…¨é‡æ‰«æçº¦éœ€ 50 ç§’ï¼Œå»ºè®® â‰¥60 ç§’</small>
                    </div>
                    <button class="btn btn-primary" onclick="saveSettings()" style="width: 100%;">
                        ğŸ’¾ ä¿å­˜è®¾ç½®
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-title">ğŸ¤– æ‰«ææ§åˆ¶</div>
                    <p style="font-size: 12px; color: #9ca3af; margin-bottom: 15px;">
                        å®šæ—¶å…¨é‡æ‰«æ 16000+ å¸‚åœºï¼Œå‘ç°ä»·æ ¼åç¦»æœºä¼š
                    </p>
                    
                    <!-- è‡ªåŠ¨æ‰«æå¼€å…³ -->
                    <div class="auto-scan-toggle" style="margin-bottom: 15px;">
                        <label class="toggle-switch">
                            <input type="checkbox" id="autoScanToggle" onchange="toggleAutoScan()">
                            <span class="toggle-slider"></span>
                        </label>
                        <span style="margin-left: 10px; font-size: 14px;">
                            <span id="autoScanStatus">ğŸ”´ è‡ªåŠ¨æ‰«æå·²å…³é—­</span>
                        </span>
                    </div>
                    
                    <div class="control-panel">
                        <button class="btn btn-success" id="startBtn" onclick="startBot()">â–¶ï¸ å¯åŠ¨</button>
                        <button class="btn btn-danger" id="stopBtn" onclick="stopBot()" disabled>â¹ï¸ åœæ­¢</button>
                    </div>
                    <div class="control-panel">
                        <button class="btn btn-info btn-sm" onclick="refreshMarkets()">ğŸ”„ ç«‹å³æ‰«æ</button>
                        <button class="btn btn-secondary btn-sm" onclick="loadFileLogs()">ğŸ“„ åˆ·æ–°æ—¥å¿—</button>
                    </div>
                    
                    <div class="scan-progress" id="scanProgress" style="display: none;">
                        <div style="display: flex; justify-content: space-between; font-size: 12px;">
                            <span>æ­£åœ¨æ‰«æ...</span>
                            <span id="scanProgressText">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-bar-fill" id="scanProgressBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ä¸­é—´ï¼šæœ€æ–°æœºä¼š -->
            <div>
                <div class="card">
                    <div class="card-title">ğŸ¯ æœ€æ–°å¥—åˆ©æœºä¼š</div>
                    <div id="latestOpportunity">
                        <div class="empty-state">
                            <div class="icon">ğŸ”</div>
                            <p>ç­‰å¾…å‘ç°å¥—åˆ©æœºä¼š...</p>
                            <p style="font-size: 11px; margin-top: 10px;">å¸‚åœºæ•ˆç‡é«˜æ—¶å¯èƒ½å¾ˆéš¾å‘ç°æœºä¼š</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šå¸‚åœºç›‘æ§ -->
            <div>
                <div class="card">
                    <div class="card-title">ğŸ“ˆ ä»·æ ¼åç¦»å¸‚åœº (Top 15) <span style="font-size: 11px; color: #6b7280;">ç‚¹å‡»è·³è½¬è¯¦æƒ…</span></div>
                    <div style="max-height: 500px; overflow-y: auto;">
                        <div id="marketList">
                            <div class="empty-state" style="padding: 30px;">
                                <div class="icon">ğŸ”</div>
                                <p>åŠ è½½ä¸­...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ—¥å¿—åŒºåŸŸ -->
        <div class="grid-2">
            <div class="card">
                <div class="card-title">ğŸ“‹ è¿è¡Œæ—¥å¿—</div>
                <div class="logs-container" id="logsContainer">
                    <div class="log-entry">ç­‰å¾…å¯åŠ¨...</div>
                </div>
            </div>
            
            <div class="card">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab(this, 'opportunities')">ğŸ¯ å¥—åˆ©æœºä¼šè®°å½•</div>
                    <div class="tab" onclick="switchTab(this, 'scans')">ğŸ“Š æ‰«æå†å²</div>
                </div>
                
                <div id="tab-opportunities" class="tab-content active">
                    <div class="file-logs" id="opportunityLogs">
                        <div class="file-log-entry">ç‚¹å‡»"åˆ·æ–°æ—¥å¿—"åŠ è½½...</div>
                    </div>
                </div>
                
                <div id="tab-scans" class="tab-content">
                    <div class="file-logs" id="scanLogs">
                        <div class="file-log-entry">ç‚¹å‡»"åˆ·æ–°æ—¥å¿—"åŠ è½½...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script>
        const API_BASE = '';
        let isRunning = false;
        
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show' + (isError ? ' error' : '');
            setTimeout(() => { toast.className = 'toast'; }, 3000);
        }
        
        function addLog(message, type = '') {
            const container = document.getElementById('logsContainer');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.insertBefore(entry, container.firstChild);
            while (container.children.length > 100) container.removeChild(container.lastChild);
        }
        
        function switchTab(el, tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }
        
        async function fetchStats() {
            try {
                const res = await fetch(API_BASE + '/api/arbitrage/stats');
                const data = await res.json();
                if (data.success) {
                    document.getElementById('totalScans').textContent = (data.data.scanCount || 0).toLocaleString();
                    document.getElementById('opportunitiesFound').textContent = data.data.opportunityCount || 0;
                    document.getElementById('tradesExecuted').textContent = data.data.tradeCount || 0;
                    document.getElementById('totalProfit').textContent = '$' + (data.data.totalProfit || 0).toFixed(2);
                    document.getElementById('totalMarkets').textContent = (data.data.totalMarkets || 0).toLocaleString();
                    document.getElementById('deviatedMarkets').textContent = data.data.deviatedMarkets || 0;
                    
                    const badge = document.getElementById('statusBadge');
                    if (data.data.isRunning) {
                        badge.className = 'status-badge status-running';
                        badge.textContent = 'ğŸŸ¢ è¿è¡Œä¸­';
                        document.getElementById('startBtn').disabled = true;
                        document.getElementById('stopBtn').disabled = false;
                        isRunning = true;
                    } else {
                        badge.className = 'status-badge status-stopped';
                        badge.textContent = 'âšª å·²åœæ­¢';
                        document.getElementById('startBtn').disabled = false;
                        document.getElementById('stopBtn').disabled = true;
                        isRunning = false;
                    }
                }
            } catch (error) { console.error('è·å–ç»Ÿè®¡å¤±è´¥:', error); }
        }
        
        async function fetchMarkets() {
            try {
                const res = await fetch(API_BASE + '/api/arbitrage/markets');
                const data = await res.json();
                if (data.success && data.data.length > 0) {
                    const container = document.getElementById('marketList');
                    container.innerHTML = data.data.slice(0, 15).map(m => {
                        const spreadAbs = Math.abs(m.spread);
                        let spreadClass = 'spread-low';
                        if (spreadAbs >= 1) spreadClass = 'good';
                        else if (spreadAbs >= 0.5) spreadClass = 'ok';
                        
                        // æ ¹æ® deviationType åˆ¤æ–­å¥—åˆ©ç±»å‹
                        const isLong = m.deviationType === 'LONG';
                        const typeClass = isLong ? 'type-long' : 'type-short';
                        const typeText = isLong ? 'ğŸ“ˆ åšå¤š' : 'ğŸ“‰ åšç©º';
                        const typeBadgeClass = isLong ? 'type-long' : 'type-short';
                        const priceLabel = isLong ? 'ä¹°å…¥ä»·' : 'å–å‡ºä»·';
                        const actionLabel = isLong ? 'ä¹°å…¥æ€»ä»·' : 'å–å‡ºæ€»ä»·';
                        
                        // Polymarket URL - ä½¿ç”¨äº‹ä»¶ slug + conditionId å®šä½åˆ°å…·ä½“å¸‚åœº
                        let marketUrl = 'https://polymarket.com';
                        if (m.slug) {
                            marketUrl = `https://polymarket.com/event/${m.slug}`;
                            // å¦‚æœæœ‰ conditionIdï¼Œæ·»åŠ å‚æ•°å®šä½åˆ°å…·ä½“å¸‚åœº
                            if (m.conditionId) {
                                marketUrl += `?tid=${m.conditionId}`;
                            }
                        } else if (m.conditionId) {
                            // æ²¡æœ‰ slug æ—¶ï¼Œç›´æ¥æœç´¢ conditionId
                            marketUrl = `https://polymarket.com/markets?q=${m.conditionId}`;
                        }
                        
                        // è®¡ç®— 1000U é¢„ä¸‹å•æ”¶ç›Šï¼ˆä½¿ç”¨çœŸå®è®¢å•ç°¿ä»·æ ¼ï¼‰
                        const investAmount = 1000; // æŠ•å…¥é‡‘é¢
                        const gasPerTx = 0.01; // æ¯ç¬”äº¤æ˜“ Gas è´¹çº¦ $0.01 (Polygon)
                        const numTxs = 2; // ä¹°/å– YES + ä¹°/å– NO = 2 ç¬”äº¤æ˜“
                        const gasFee = gasPerTx * numTxs;
                        // çœŸå®ä»·æ ¼å·²ç»åŒ…å«æ»‘ç‚¹ï¼Œé¢å¤–é¢„ç•™ 0.05% ä½œä¸ºä»·æ ¼æ³¢åŠ¨ç¼“å†²
                        const bufferRate = 0.0005;
                        const bufferCost = investAmount * bufferRate;
                        const priceSum = m.priceSum || 1;
                        
                        let grossProfit;
                        if (isLong) {
                            // åšå¤š: ä¹°å…¥æ‰€æœ‰ç»“æœï¼Œç­‰å¾…ç»“ç®—è·å¾— 1 ç¾å…ƒ
                            // æ”¶ç›Š = æŠ•å…¥ Ã— (1 - ä»·æ ¼å’Œ) / ä»·æ ¼å’Œ
                            grossProfit = investAmount * (1 - priceSum) / priceSum;
                        } else {
                            // åšç©º: å–å‡ºæ‰€æœ‰ç»“æœï¼Œä»·æ ¼å’Œ > 1
                            // æ”¶ç›Š = æŠ•å…¥ Ã— (ä»·æ ¼å’Œ - 1)
                            grossProfit = investAmount * (priceSum - 1);
                        }
                        const totalFees = gasFee + bufferCost;
                        const netProfit = grossProfit - totalFees;
                        const roi = (netProfit / investAmount * 100);
                        
                        const profitClass = netProfit > 0 ? 'positive' : (netProfit < 0 ? 'negative' : 'neutral');
                        
                        return `
                            <div class="market-item ${typeClass}" onclick="window.open('${marketUrl}', '_blank')">
                                <div class="market-item-header">
                                    <div class="market-item-title">${m.question}</div>
                                    <div class="market-item-type">
                                        <span class="type-badge ${typeBadgeClass}">${typeText}</span>
                                    </div>
                                </div>
                                <div class="market-item-prices">
                                    <div class="market-price yes">
                                        <div class="price-label">YES ${priceLabel}</div>
                                        <div class="price-value">$${(m.upPrice || 0).toFixed(4)}</div>
                                    </div>
                                    <div class="market-price no">
                                        <div class="price-label">NO ${priceLabel}</div>
                                        <div class="price-value">$${(m.downPrice || 0).toFixed(4)}</div>
                                    </div>
                                </div>
                                <div class="market-item-footer">
                                    <div>
                                        <span>${actionLabel}: <strong>${m.priceSum.toFixed(4)}</strong></span>
                                        <span style="margin-left: 15px;">å¥—åˆ©ç©ºé—´: <span class="spread ${spreadClass}">${Math.abs(m.spread).toFixed(2)}%</span></span>
                                    </div>
                                    <div class="link-hint">
                                        <span>æŸ¥çœ‹è¯¦æƒ…</span>
                                        <span>â†’</span>
                                    </div>
                                </div>
                                <div class="profit-simulation">
                                    <div class="profit-simulation-title">
                                        ğŸ’° é¢„ä¸‹å•æ¨¡æ‹Ÿ (æŠ•å…¥ $${investAmount})
                                    </div>
                                    <div class="profit-simulation-grid">
                                        <div class="profit-item">
                                            <div class="label">æ¯›æ”¶ç›Š</div>
                                            <div class="value ${grossProfit >= 0 ? 'positive' : 'negative'}">
                                                ${grossProfit >= 0 ? '+' : ''}$${grossProfit.toFixed(2)}
                                            </div>
                                        </div>
                                        <div class="profit-item">
                                            <div class="label">Gas+ç¼“å†²</div>
                                            <div class="value negative">-$${totalFees.toFixed(2)}</div>
                                        </div>
                                        <div class="profit-item">
                                            <div class="label">å‡€æ”¶ç›Š</div>
                                            <div class="value ${profitClass}">
                                                ${netProfit >= 0 ? '+' : ''}$${netProfit.toFixed(2)}
                                                <span style="font-size: 10px; opacity: 0.7;">(${roi >= 0 ? '+' : ''}${roi.toFixed(2)}%)</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="font-size: 9px; color: #6b7280; margin-top: 6px; text-align: center;">
                                        Gas: $${gasFee.toFixed(2)} (${numTxs}ç¬”Ã—$${gasPerTx}) | ä»·æ ¼ç¼“å†²: $${bufferCost.toFixed(2)} (0.05%) | Polymarket: $0
                                    </div>
                                </div>
                            </div>`;
                    }).join('');
                } else {
                    document.getElementById('marketList').innerHTML = `
                        <div class="empty-state">
                            <div class="icon">âœ…</div>
                            <p>æš‚æ— ä»·æ ¼åç¦»å¸‚åœº</p>
                            <p style="font-size: 11px; margin-top: 10px;">å¸‚åœºæ•ˆç‡é«˜ï¼Œæ‰€æœ‰ä»·æ ¼å’Œ â‰ˆ 1.0000</p>
                        </div>`;
                }
            } catch (error) { console.error('è·å–å¸‚åœºå¤±è´¥:', error); }
        }
        
        async function fetchLatestOpportunity() {
            try {
                const res = await fetch(API_BASE + '/api/arbitrage/opportunity');
                const data = await res.json();
                if (data.success && data.data) {
                    const opp = data.data;
                    const isLong = opp.deviationType === 'LONG' || opp.spread > 0;
                    const typeClass = isLong ? 'long' : 'short';
                    const typeText = isLong ? 'ğŸ“ˆ åšå¤šæœºä¼š' : 'ğŸ“‰ åšç©ºæœºä¼š';
                    const priceLabel = isLong ? 'ä¹°å…¥ä»·' : 'å–å‡ºä»·';
                    
                    document.getElementById('latestOpportunity').innerHTML = `
                        <div class="opportunity-card ${typeClass}">
                            <h4>${opp.market.question}</h4>
                            <div style="margin-bottom: 10px;">
                                <span class="type-badge type-${typeClass}">${typeText}</span>
                            </div>
                            <div class="price-pair">
                                <div class="price-box up">
                                    <div class="label">YES ${priceLabel}</div>
                                    <div class="value">$${opp.upPrice.toFixed(4)}</div>
                                </div>
                                <div class="price-box down">
                                    <div class="label">NO ${priceLabel}</div>
                                    <div class="value">$${opp.downPrice.toFixed(4)}</div>
                                </div>
                            </div>
                            <div class="stats-row"><span>ä»·æ ¼å’Œ</span><span>${opp.priceSum.toFixed(6)}</span></div>
                            <div class="stats-row"><span>ä»·å·®</span><span class="${isLong ? 'profit' : 'loss'}">${Math.abs(opp.spread).toFixed(4)}%</span></div>
                            <div class="stats-row"><span>é¢„æœŸåˆ©æ¶¦</span><span class="profit">$${opp.profit.toFixed(4)}</span></div>
                            <div class="stats-row"><span>å‘ç°æ—¶é—´</span><span style="font-size: 11px;">${new Date(opp.timestamp).toLocaleString()}</span></div>
                        </div>`;
                }
            } catch (error) { console.error('è·å–æœ€æ–°æœºä¼šå¤±è´¥:', error); }
        }
        
        async function loadFileLogs() {
            try {
                const oppRes = await fetch(API_BASE + '/api/arbitrage/logs/opportunities');
                const oppData = await oppRes.json();
                if (oppData.success && oppData.data) {
                    const container = document.getElementById('opportunityLogs');
                    const lines = oppData.data.split('\n').filter(line => line.trim());
                    if (lines.length > 0) {
                        container.innerHTML = lines.map(line => {
                            let cls = '';
                            if (line.includes('åšå¤š')) cls = 'long';
                            else if (line.includes('åšç©º')) cls = 'short';
                            else if (line.includes('æ‰«æç»Ÿè®¡')) cls = 'stats';
                            return `<div class="file-log-entry ${cls}">${line}</div>`;
                        }).join('');
                    } else {
                        container.innerHTML = '<div class="file-log-entry">æš‚æ— å¥—åˆ©æœºä¼šè®°å½•</div>';
                    }
                }
                
                const scanRes = await fetch(API_BASE + '/api/arbitrage/logs/scan-history');
                const scanData = await scanRes.json();
                if (scanData.success && scanData.data) {
                    const container = document.getElementById('scanLogs');
                    const lines = scanData.data.split('\n').filter(line => line.trim());
                    if (lines.length > 0) {
                        container.innerHTML = lines.map(line => `<div class="file-log-entry">${line}</div>`).join('');
                    } else {
                        container.innerHTML = '<div class="file-log-entry">æš‚æ— æ‰«æå†å²</div>';
                    }
                }
                
                showToast('ğŸ“„ æ—¥å¿—å·²åˆ·æ–°');
            } catch (error) {
                console.error('åŠ è½½æ–‡ä»¶æ—¥å¿—å¤±è´¥:', error);
                showToast('åŠ è½½æ—¥å¿—å¤±è´¥', true);
            }
        }
        
        // è‡ªåŠ¨æ‰«æç›¸å…³å‡½æ•°
        function loadAutoScanSetting() {
            const autoScan = localStorage.getItem('autoScanEnabled') === 'true';
            document.getElementById('autoScanToggle').checked = autoScan;
            updateAutoScanStatus(autoScan);
            return autoScan;
        }
        
        function saveAutoScanSetting(enabled) {
            localStorage.setItem('autoScanEnabled', enabled ? 'true' : 'false');
        }
        
        function updateAutoScanStatus(enabled) {
            const statusEl = document.getElementById('autoScanStatus');
            if (enabled) {
                statusEl.innerHTML = 'ğŸŸ¢ è‡ªåŠ¨æ‰«æå·²å¼€å¯';
                statusEl.style.color = '#10b981';
            } else {
                statusEl.innerHTML = 'ğŸ”´ è‡ªåŠ¨æ‰«æå·²å…³é—­';
                statusEl.style.color = '#9ca3af';
            }
        }
        
        async function toggleAutoScan() {
            const enabled = document.getElementById('autoScanToggle').checked;
            saveAutoScanSetting(enabled);
            updateAutoScanStatus(enabled);
            
            if (enabled) {
                showToast('âœ… è‡ªåŠ¨æ‰«æå·²å¼€å¯');
                addLog('è‡ªåŠ¨æ‰«æå·²å¼€å¯ï¼Œå°†è‡ªåŠ¨å¯åŠ¨æ‰«æ', 'success');
                // å¦‚æœå½“å‰æœªè¿è¡Œï¼Œç«‹å³å¯åŠ¨
                if (!isRunning) {
                    await startBot();
                }
            } else {
                showToast('â¸ï¸ è‡ªåŠ¨æ‰«æå·²å…³é—­');
                addLog('è‡ªåŠ¨æ‰«æå·²å…³é—­', 'warning');
            }
        }
        
        async function startBot() {
            try {
                addLog('æ­£åœ¨å¯åŠ¨æ‰«æ...', 'info');
                const res = await fetch(API_BASE + '/api/arbitrage/start', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    showToast('âš¡ å¥—åˆ©æ‰«æå·²å¯åŠ¨');
                    addLog('æ‰«æå·²å¯åŠ¨ï¼Œå…¨é‡æ‰«æçº¦éœ€ 50 ç§’', 'success');
                    fetchStats();
                } else {
                    showToast('å¯åŠ¨å¤±è´¥: ' + data.error, true);
                    addLog('å¯åŠ¨å¤±è´¥: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('å¯åŠ¨å¤±è´¥', true);
                addLog('å¯åŠ¨å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function stopBot() {
            try {
                const res = await fetch(API_BASE + '/api/arbitrage/stop', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    showToast('â¹ï¸ æ‰«æå·²åœæ­¢');
                    addLog('æ‰«æå·²åœæ­¢');
                    fetchStats();
                } else {
                    showToast('åœæ­¢å¤±è´¥: ' + data.error, true);
                }
            } catch (error) { showToast('åœæ­¢å¤±è´¥', true); }
        }
        
        async function saveSettings() {
            const settings = {
                minSpread: parseFloat(document.getElementById('minSpread').value),
                tradeAmount: parseFloat(document.getElementById('tradeAmount').value),
                scanInterval: parseInt(document.getElementById('scanInterval').value) * 1000
            };
            
            try {
                const res = await fetch(API_BASE + '/api/arbitrage/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                const data = await res.json();
                if (data.success) {
                    showToast('âœ… è®¾ç½®å·²ä¿å­˜');
                    addLog(`è®¾ç½®å·²æ›´æ–°: æœ€å°ä»·å·®=${settings.minSpread}%, é—´éš”=${settings.scanInterval/1000}ç§’`, 'success');
                } else { showToast('ä¿å­˜å¤±è´¥', true); }
            } catch (error) { showToast('ä¿å­˜å¤±è´¥', true); }
        }
        
        async function refreshMarkets() {
            showToast('ğŸ”„ æ­£åœ¨æ‰«æå¸‚åœº...');
            addLog('æ‰‹åŠ¨è§¦å‘å¸‚åœºæ‰«æ...', 'info');
            
            document.getElementById('scanProgress').style.display = 'block';
            document.getElementById('scanProgressBar').style.width = '0%';
            document.getElementById('scanProgressText').textContent = '0%';
            
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 8;
                if (progress > 95) progress = 95;
                document.getElementById('scanProgressBar').style.width = progress + '%';
                document.getElementById('scanProgressText').textContent = Math.round(progress) + '%';
            }, 500);
            
            try {
                await fetch(API_BASE + '/api/arbitrage/scan', { method: 'POST' });
                clearInterval(progressInterval);
                document.getElementById('scanProgressBar').style.width = '100%';
                document.getElementById('scanProgressText').textContent = '100%';
                
                await fetchMarkets();
                await fetchStats();
                await loadFileLogs();
                
                showToast('âœ… æ‰«æå®Œæˆ');
                addLog('å¸‚åœºæ‰«æå®Œæˆ', 'success');
            } catch (error) {
                clearInterval(progressInterval);
                showToast('æ‰«æå¤±è´¥', true);
                addLog('æ‰«æå¤±è´¥: ' + error.message, 'error');
            }
            
            setTimeout(() => { document.getElementById('scanProgress').style.display = 'none'; }, 1500);
        }
        
        async function fetchSettings() {
            try {
                const res = await fetch(API_BASE + '/api/arbitrage/settings');
                const data = await res.json();
                if (data.success && data.data) {
                    document.getElementById('minSpread').value = data.data.minSpread || 0.5;
                    document.getElementById('tradeAmount').value = data.data.tradeAmount || 10;
                    document.getElementById('scanInterval').value = Math.round((data.data.scanInterval || 60000) / 1000);
                }
            } catch (error) { console.error('è·å–è®¾ç½®å¤±è´¥:', error); }
        }
        
        async function init() {
            // æ¸…ç©ºåˆå§‹çš„"ç­‰å¾…å¯åŠ¨..."
            document.getElementById('logsContainer').innerHTML = '';
            addLog('é¡µé¢åŠ è½½å®Œæˆï¼Œæ­£åœ¨åˆå§‹åŒ–...', 'info');
            
            // åŠ è½½è‡ªåŠ¨æ‰«æè®¾ç½®
            const autoScanEnabled = loadAutoScanSetting();
            
            await Promise.all([fetchStats(), fetchMarkets(), fetchLatestOpportunity(), fetchSettings()]);
            addLog('åˆå§‹åŒ–å®Œæˆ', 'success');
            loadFileLogs();
            
            // æ ¹æ®è‡ªåŠ¨æ‰«æè®¾ç½®å†³å®šæ˜¯å¦è‡ªåŠ¨å¯åŠ¨
            setTimeout(async () => {
                if (autoScanEnabled && !isRunning) {
                    addLog('è‡ªåŠ¨æ‰«æå·²å¼€å¯ï¼Œæ­£åœ¨å¯åŠ¨...', 'info');
                    await startBot();
                } else if (!autoScanEnabled) {
                    addLog('ğŸ’¡ è‡ªåŠ¨æ‰«æå·²å…³é—­ï¼Œç‚¹å‡»å¼€å…³å¯å¼€å¯è‡ªåŠ¨æ‰«æ', 'info');
                }
            }, 1000);
        }
        
        init();
        setInterval(fetchStats, 5000);
        setInterval(fetchMarkets, 10000);
        setInterval(fetchLatestOpportunity, 5000);
        // è‡ªåŠ¨åˆ·æ–°æ—¥å¿—æ–‡ä»¶
        setInterval(loadFileLogs, 30000);
    </script>
</body>
</html>
