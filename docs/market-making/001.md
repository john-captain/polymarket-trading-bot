# 做市策略 (Market-Making) 配置需求完整说明

## 一、策略目标

**场景**：小资金做市（20U-100U），在 Polymarket 预测市场上双边挂单赚取价差利润。

**核心逻辑**：
1. 筛选出适合小资金做市的市场
2. 在买卖两侧挂单，赚取 spread
3. 控制风险，避免被高频机器人收割

---

## 二、6 大筛选条件与数据源对照

| 条件类别 | 配置字段 | 数据源 | 可用性 |
|---------|---------|--------|-------|
| **① 成交活跃度** | | | |
| 24h交易量 | `minVolume24h` | `volume24hr` (Gamma API) | ✅ 可用 |
| 每分钟成交次数 | `minTradesPerMinute` | ❌ API 不提供 | ❌ **移除** |
| 最近成交时间 | `maxLastTradeAge` | ❌ API 不提供 `lastTradeTime` | ❌ **移除** |
| **② Spread 筛选** | | | |
| 最小市场价差 | `minMarketSpread` | `spread` (Gamma API) | ✅ 可用 |
| 最大市场价差 | `maxMarketSpread` | `spread` (Gamma API) | ✅ 可用 |
| **③ 波动率筛选** | | | |
| 最大价格波动 | `maxVolatility` | `oneDayPriceChange` (近似) | ⚠️ 近似可用 |
| 价格区间最小值 | `priceRangeMin` | `outcomePrices[0]` | ✅ 可用 |
| 价格区间最大值 | `priceRangeMax` | `outcomePrices[0]` | ✅ 可用 |
| 最小剩余天数 | `minDaysUntilEnd` | `endDate` (计算) | ✅ 可用 |
| **④ 深度筛选** | | | |
| 最小流动性 | `minLiquidity` | `liquidity` (Gamma API) | ✅ 可用 |
| 订单簿深度(条数) | `minOrderBookDepth` | ❌ 需实时 CLOB API | ❌ **移除** |
| 深度金额 | `minDepthAmount` | ❌ 需实时 CLOB API | ❌ **移除** |
| **⑤ 手续费控制** | | | |
| 最小单笔订单 | `minOrderSize` | `orderMinSize` (Gamma API) | ✅ 可用 |
| 预估手续费率 | `estimatedFeeRate` | 固定配置 | ✅ 可用 |
| **⑥ 竞争检测** | | | |
| 启用竞争检测 | `enableCompetitionDetection` | - | ✅ 配置项 |
| 竞争度阈值 | `maxCompetitive` | `competitive` (Gamma API) | ✅ 可用 |
| 订单刷新频率 | `maxOrderRefreshRate` | ❌ 需 WebSocket 监控 | ❌ **移除** |
| 被插队次数 | `maxFrontRunCount` | ❌ 需实时交易监控 | ❌ **移除** |

---

## 三、简化后的配置结构

### 移除的字段（6 个）
```typescript
// ❌ 无法获取，建议移除
minTradesPerMinute    // 每分钟成交次数 - API 不提供
maxLastTradeAge       // 最近成交时间 - API 不提供
minOrderBookDepth     // 订单簿深度 - 需实时 CLOB API
minDepthAmount        // 深度金额 - 需实时 CLOB API  
maxOrderRefreshRate   // 订单刷新频率 - 需 WebSocket
maxFrontRunCount      // 被插队次数 - 需实时监控
```

### 保留的字段（简化版）
```typescript
export interface MarketMakingConfig {
	/** 是否启用 */
	enabled: boolean
	/** 是否自动执行 */
	autoExecute: boolean
  
	// ========== 做市参数 ==========
	/** 买卖价差 (%) - 你挂单的 spread */
	spreadPercent: number
	/** 单笔订单大小 ($) */
	orderSize: number
	/** 单边最大持仓 ($) */
	maxPositionPerSide: number
	/** 订单刷新间隔 (ms) */
	refreshIntervalMs: number
  
	// ========== ① 成交活跃度筛选 ==========
	/** 最小24h交易量 ($) - 建议 ≥ $5000 */
	minVolume24h: number
  
	// ========== ② Spread 筛选 ==========
	/** 最小市场价差 (%) - 建议 ≥ 1.5% */
	minMarketSpread: number
	/** 最大市场价差 (%) - 价差太大说明流动性差 */
	maxMarketSpread: number
  
	// ========== ③ 波动率筛选 ==========
	/** 最大24h价格变动 (%) - 用 oneDayPriceChange 绝对值 */
	maxPriceChange24h: number
	/** YES价格最小值 - 避免极端价格 */
	priceRangeMin: number
	/** YES价格最大值 */
	priceRangeMax: number
	/** 最小剩余天数 - 避免临近结算 */
	minDaysUntilEnd: number
  
	// ========== ④ 深度筛选 ==========
	/** 最小流动性 ($) */
	minLiquidity: number
  
	// ========== ⑤ 手续费控制 ==========
	/** 最小单笔订单 ($) - 太小被手续费吃掉 */
	minOrderSize: number
	/** 预估手续费率 (%) - Polymarket 约 0.2% */
	estimatedFeeRate: number
  
	// ========== ⑥ 竞争检测 ==========
	/** 是否启用竞争检测 */
	enableCompetitionDetection: boolean
	/** 最大竞争度 - 越低竞争越少 (0-1) */
	maxCompetitive: number
  
	// ========== 风控 ==========
	/** 库存偏斜阈值 (%) */
	skewThreshold: number
	/** 最大未平仓持仓 ($) */
	maxOpenPosition: number
	/** 是否自动 Merge 赎回 */
	autoMerge: boolean
	/** Merge 触发阈值 ($) */
	mergeThreshold: number
	/** 单日最大亏损 ($) */
	maxDailyLoss: number
  
	// ========== 冷却 ==========
	/** 冷却时间 (ms) */
	cooldownMs: number
}
```

---

## 四、默认配置值

```typescript
export const DEFAULT_MARKET_MAKING_CONFIG: MarketMakingConfig = {
	enabled: false,
	autoExecute: false,
  
	// 做市参数
	spreadPercent: 2.0,           // 挂单 2% spread
	orderSize: 5,                 // 每单 $5
	maxPositionPerSide: 50,       // 单边最大 $50
	refreshIntervalMs: 30000,     // 30 秒刷新
  
	// ① 成交活跃度
	minVolume24h: 5000,           // 24h 至少 $5000 交易量
  
	// ② Spread
	minMarketSpread: 1.5,         // 市场 spread ≥ 1.5%
	maxMarketSpread: 10,          // 市场 spread ≤ 10%
  
	// ③ 波动率
	maxPriceChange24h: 15,        // 24h 涨跌幅 ≤ 15%
	priceRangeMin: 0.35,          // YES 价格 ≥ 0.35
	priceRangeMax: 0.65,          // YES 价格 ≤ 0.65
	minDaysUntilEnd: 10,          // 至少 10 天到期
  
	// ④ 深度
	minLiquidity: 1000,           // 流动性 ≥ $1000
  
	// ⑤ 手续费
	minOrderSize: 0.5,            // 最小订单 $0.5
	estimatedFeeRate: 0.2,        // 手续费 0.2%
  
	// ⑥ 竞争
	enableCompetitionDetection: true,
	maxCompetitive: 0.8,          // 竞争度 ≤ 0.8 (越低越好)
  
	// 风控
	skewThreshold: 60,            // 单边超过 60% 触发调整
	maxOpenPosition: 100,         // 最大持仓 $100
	autoMerge: true,
	mergeThreshold: 20,           // 双边都超 $20 时 Merge
	maxDailyLoss: 10,             // 日亏损 $10 暂停
  
	// 冷却
	cooldownMs: 5000,
}
```

---

## 五、数据库字段映射 (SQL 查询)

```sql
-- 筛选适合做市的市场
SELECT 
	m.conditionId,
	m.question,
	m.endDate,
	m.orderMinSize,
	ph.volume24hr,
	ph.spread,
	ph.liquidity,
	ph.outcomePrices,
	ph.oneDayPriceChange,
	ph.competitive
FROM markets m
JOIN (
	SELECT condition_id, MAX(id) as latest_id 
	FROM market_price_history 
	GROUP BY condition_id
) lp ON m.conditionId = lp.condition_id
JOIN market_price_history ph ON lp.latest_id = ph.id
WHERE 
	m.active = 1 
	AND m.closed = 0
	AND m.enableOrderBook = 1
	-- ① 成交活跃度
	AND ph.volume24hr >= 5000
	-- ② Spread
	AND ph.spread >= 0.015              -- 1.5%
	AND ph.spread <= 0.10               -- 10%
	-- ③ 波动率
	AND ABS(COALESCE(ph.oneDayPriceChange, 0)) <= 0.15
	AND JSON_EXTRACT(ph.outcomePrices, '$[0]') BETWEEN 0.35 AND 0.65
	AND m.endDate > DATE_ADD(NOW(), INTERVAL 10 DAY)
	-- ④ 深度
	AND ph.liquidity >= 1000
	-- ⑤ 手续费 (orderMinSize 已在 markets 表)
	-- ⑥ 竞争
	AND COALESCE(ph.competitive, 0) <= 0.8
ORDER BY ph.volume24hr DESC
LIMIT 20;
```

---

## 六、UI 配置页面结构

```
做市策略配置
├── 基础设置
│   ├── 启用策略 [开关]
│   └── 自动执行 [开关]
│
├── 做市参数
│   ├── 挂单价差 (%) [输入框] 默认 2.0
│   ├── 单笔订单 ($) [输入框] 默认 5
│   ├── 单边最大持仓 ($) [输入框] 默认 50
│   └── 订单刷新间隔 (秒) [输入框] 默认 30
│
├── 市场筛选条件
│   ├── ① 成交活跃度
│   │   └── 最小24h交易量 ($) [输入框] 默认 5000
│   │
│   ├── ② Spread 筛选
│   │   ├── 最小市场价差 (%) [输入框] 默认 1.5
│   │   └── 最大市场价差 (%) [输入框] 默认 10
│   │
│   ├── ③ 波动率筛选
│   │   ├── 最大24h涨跌幅 (%) [输入框] 默认 15
│   │   ├── YES价格区间 [双滑块] 默认 0.35-0.65
│   │   └── 最小剩余天数 [输入框] 默认 10
│   │
│   ├── ④ 深度筛选
│   │   └── 最小流动性 ($) [输入框] 默认 1000
│   │
│   ├── ⑤ 手续费控制
│   │   ├── 最小订单金额 ($) [输入框] 默认 0.5
│   │   └── 预估手续费率 (%) [输入框] 默认 0.2
│   │
│   └── ⑥ 竞争检测
│       ├── 启用竞争检测 [开关]
│       └── 最大竞争度 [滑块] 默认 0.8
│
└── 风控设置
		├── 库存偏斜阈值 (%) [输入框] 默认 60
		├── 最大持仓 ($) [输入框] 默认 100
		├── 自动 Merge [开关]
		├── Merge 触发阈值 ($) [输入框] 默认 20
		└── 单日最大亏损 ($) [输入框] 默认 10
```

---

## 七、变更总结

### 移除的配置项 (6 个)
| 字段 | 原因 |
|-----|------|
| `minTradesPerMinute` | Gamma API 不提供成交次数 |
| `maxLastTradeAge` | Gamma API 不提供最后成交时间戳 |
| `minOrderBookDepth` | 需要实时调用 CLOB API，不适合配置筛选 |
| `minDepthAmount` | 需要实时调用 CLOB API |
| `maxOrderRefreshRate` | 需要 WebSocket 实时监控 |
| `maxFrontRunCount` | 需要实时交易监控 |

### 修改的配置项 (2 个)
| 字段 | 变更 |
|-----|------|
| `maxVolatility` | → `maxPriceChange24h`，使用 `oneDayPriceChange` 绝对值 |
| `maxCompetitive` | 新增，替代无法实现的刷新频率检测 |

### 保留的配置项 (20 个)
- 基础：`enabled`, `autoExecute`
- 做市：`spreadPercent`, `orderSize`, `maxPositionPerSide`, `refreshIntervalMs`
- 筛选：`minVolume24h`, `minMarketSpread`, `maxMarketSpread`, `maxPriceChange24h`, `priceRangeMin`, `priceRangeMax`, `minDaysUntilEnd`, `minLiquidity`, `minOrderSize`, `estimatedFeeRate`, `enableCompetitionDetection`, `maxCompetitive`
- 风控：`skewThreshold`, `maxOpenPosition`, `autoMerge`, `mergeThreshold`, `maxDailyLoss`, `cooldownMs`

---

确认后我可以：
1. 在 `src/lib/queue/strategy-config.ts` 中更新 `MarketMakingConfig` 类型与默认值（如同上文）
2. 更新前端配置页面 `src/app/(dashboard)/strategies/market-making/config/page.tsx`，移除无法实现字段并调整 UI
3. 实现 SQL 初筛（已包含示例）和运行时的 CLOB 检查（挂单前调用）

如果需要，我会继续把这些代码改动一并提交。

