# 系统架构设计

> 本文档包含 PRD 第一至三章：项目背景、需求概述、系统架构设计

---

## 一、项目背景

### 1.1 现状分析

当前系统使用 `setInterval` 实现定时扫描，存在以下问题：

| 问题 | 影响 | 严重程度 |
|------|------|----------|
| 同步执行 | 扫描、存储、策略检查串行执行，效率低 | 高 |
| 无背压控制 | 任务堆积可能导致内存溢出 | 高 |
| 数据未持久化 | 扫描数据只在内存中，重启丢失 | 中 |
| 策略解耦差 | 三个策略没有独立的执行队列 | 中 |
| 无法并行 | 发现机会后无法快速响应 | 中 |

### 1.2 现有代码结构

```
src/lib/
├── arbitrage-scanner.ts    # 套利扫描 (328行)
├── bot-state.ts            # 全局状态 (113行)
├── database.ts             # MySQL 操作 (980行)
├── strategies/
│   ├── index.ts            # 策略管理器 (241行)
│   ├── mint-split.ts       # 铸造拆分策略 (592行)
│   └── market-making.ts    # 做市策略 (547行)
```

### 1.3 升级目标

1. **引入内存队列系统** - 使用 `p-queue` 实现轻量级队列
2. **异步解耦** - 扫描、存储、策略检查、下单独立运行
3. **背压控制** - 防止任务堆积导致内存溢出
4. **全量持久化** - 扫描数据存入 MySQL
5. **机会追踪** - 新增机会列表页面

---

## 二、需求概述

### 2.1 核心需求

| 需求ID | 需求描述 | 优先级 |
|--------|----------|--------|
| REQ-001 | 实现内存队列系统（扫描/存储/策略/下单） | P0 |
| REQ-002 | 扫描数据存入 MySQL（基础信息+价格历史） | P0 |
| REQ-003 | 发现的套利机会自动执行下单 | P0 |
| REQ-004 | 新增机会列表页面 `/opportunities` | P0 |
| REQ-005 | **扫描配置可在页面设置（数量/分类/深度等）** | P0 |
| REQ-006 | 页面显示队列状态（实时） | P1 |
| REQ-007 | 背压控制（队列满时暂停扫描） | P1 |
| REQ-008 | 错误记录和日志持久化 | P2 |

### 2.2 非功能需求

| 需求ID | 需求描述 | 指标 |
|--------|----------|------|
| NFR-001 | 内存占用 | < 512MB |
| NFR-002 | 扫描延迟 | < 5秒完成一轮 |
| NFR-003 | 下单延迟 | 发现机会后 < 2秒下单 |
| NFR-004 | 数据持久化 | 重启不丢失历史记录 |

---

## 三、系统架构设计

### 3.1 队列架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           用户界面 (Next.js)                              │
│   /markets/scan  │  /markets/sync  │  /opportunities  │  策略配置页面    │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       队列调度器 (QueueScheduler)                         │
│                     src/lib/queue/scheduler.ts                          │
│                                                                         │
│   ┌─────────────┐    启动/停止    ┌─────────────┐                       │
│   │  扫描控制器  │ ◄────────────► │  背压监控器  │                       │
│   └─────────────┘                └─────────────┘                       │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          扫描队列 (ScanQueue)                            │
│                       从 Gamma API 获取市场数据                           │
│                       并发: 1 (串行扫描，完成后再下一轮)                    │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ 获得市场数据
                                    ▼
                    ┌───────────────┴───────────────┐
                    │                               │
                    ▼                               ▼
┌─────────────────────────────┐     ┌─────────────────────────────────────┐
│      存储队列                 │     │           策略分发器                  │
│    (StorageQueue)            │     │      (StrategyDispatcher)           │
│    异步写入 MySQL             │     │      分发给启用的策略                  │
│    并发: 10                   │     └─────────────────────────────────────┘
│    最大容量: 5000             │                     │
└─────────────────────────────┘                     │
            │                       ┌───────────────┼───────────────┐
            ▼                       ▼               ▼               ▼
┌─────────────────────┐   ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│       MySQL         │   │  Mint-Split  │ │  Arbitrage   │ │Market-Making │
│  - markets          │   │  策略队列     │ │  策略队列     │ │  策略队列     │
│  - market_history   │   │  并发: 1     │ │  并发: 1     │ │  并发: 1     │
│  - opportunities    │   │  容量: 100   │ │  容量: 100   │ │  容量: 100   │
│  - trade_records    │   └──────────────┘ └──────────────┘ └──────────────┘
└─────────────────────┘           │               │               │
                                  │  检测到机会    │               │
                                  └───────────────┼───────────────┘
                                                  ▼
                                  ┌─────────────────────────────────────┐
                                  │         交易执行队列                  │
                                  │       (OrderQueue)                  │
                                  │       并发: 可配置 (默认 1)           │
                                  │       容量: 50                      │
                                  └─────────────────────────────────────┘
                                                  │
                                                  ▼
                                  ┌─────────────────────────────────────┐
                                  │         CLOB API 下单               │
                                  │         记录到 MySQL                │
                                  └─────────────────────────────────────┘
```

### 3.2 队列配置

| 队列名称 | 并发数 | 最大容量 | 超时(ms) | 背压阈值 |
|----------|--------|----------|----------|----------|
| 扫描队列 (scan) | 1 | 1 | 120000 | - |
| 存储队列 (storage) | 10 | 5000 | 10000 | 80% |
| Mint-Split 策略队列 | 1 | 100 | 30000 | - |
| Arbitrage 策略队列 | 1 | 100 | 30000 | - |
| Market-Making 策略队列 | 1 | 100 | 30000 | - |
| 交易执行队列 (order) | 1 | 50 | 60000 | - |

### 3.3 数据流

```
1. 用户点击"启动扫描"
      │
      ▼
2. ScanQueue 执行扫描任务
      │ 从 Gamma API 获取 ~1000 个市场
      │ 从 CLOB API 获取订单簿价格
      ▼
3. 扫描完成，数据分发
      │
      ├──► StorageQueue.add(markets[])     // 异步存储，不阻塞
      │
      └──► StrategyDispatcher.dispatch(markets[])
                  │
                  ├──► MintSplitQueue (如果启用)
                  ├──► ArbitrageQueue (如果启用)
                  └──► MarketMakingQueue (如果启用)
                              │
                              ▼
4. 策略检测到机会
      │
      ▼
5. OrderQueue.add(opportunity)
      │
      ▼
6. 执行下单 → 记录结果到 MySQL
      │
      ▼
7. 检查是否继续扫描
      │ if (isRunning && storageQueue.size < 80%)
      │     goto step 2
      │ else
      │     等待或停止
```

---

## 附录：技术选型

### 队列库对比

| 库 | 优点 | 缺点 | 选择 |
|----|------|------|------|
| **p-queue** | 轻量、无依赖、纯内存 | 重启丢失 | ✅ 选用 |
| BullMQ | 持久化、分布式 | 需要 Redis | 未来考虑 |
| Bee-Queue | 轻量 Redis | 需要 Redis | - |

### 依赖包

```json
{
  "p-queue": "^8.0.1"
}
```

---

**下一章**: [02-scan-storage.md](./02-scan-storage.md) - 扫描配置与存储方案
